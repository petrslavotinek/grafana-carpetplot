{"version":3,"sources":["../../src/canvas/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","canvas","context","$carpet","find","tooltip","CarpetplotTooltip","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","days","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","xScale","legendHeight","colorScale","fragment","mouseUpHandler","originalPointColor","pointWidth","pointHeight","pointWidthRounded","pointHeightRounded","highlightContainer","highlightedBucket","$canvas","selection","active","x1","x2","events","on","render","renderingCompleted","addCarpetplot","getMinMax","getColorScale","addCarpetplotSvg","addAxes","addLegend","addCanvas","addPoints","addHighlight","Math","floor","remove","d3","select","append","attr","legend","show","LEGEND_HEIGHT","LEGEND_TOP_MARGIN","xAxis","hideLabels","getXAxisHeight","addYAxis","yAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","selectAll","style","scaleTime","domain","moment","startOf","add","range","axisLeft","ticks","getYAxisTicks","tickFormat","value","format","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","axisText","nodes","text","getBBox","count","Y_AXIS_TICK_MIN_SIZE","step","ceil","timeHour","every","time","length","diff","axisBottom","getXAxisTicks","timeFormat","labelFormat","tickSize","dayWidth","showWeekends","minBucketWidthToShowWeekends","addDayTicks","timeSaturday","timeMonday","labelFormats","from","to","X_AXIS_TICK_MIN_SIZE","timeDay","timeMonth","insert","$","node","getContext","customBase","document","createElement","container","round","pointScale","scaleLinear","cols","enter","points","d","i","buckets","map","color","nullColor","toDate","drawPoints","clearRect","elements","each","x","y","fillStyle","fillRect","scale","mode","isSpectrumMode","colorModes","SPECTRUM","isSet","stats","colorScales","getColorScaleSpectrum","CUSTOM","getColorScaleCustom","theme","themeProvider","getTheme","colorScheme","_","colorSchemes","colorInterpolator","d3ScaleChromatic","invert","getStartEnd","scaleSequential","colors","customColors","interpolator","interpolationMap","colorSpace","breakpoints","breakpoint","firstBreakpoint","isDefined","last","fill","forEach","j","Number","MAX_VALUE","maxVal","start","end","unshift","push","interpolate","undefined","prop","onMouseDown","event","pos","getMousePos","isInChart","onMouseUp","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","utc","clearSelection","onMouseLeave","clearCrosshair","onMouseMove","destroy","drawSelection","drawCrosshair","bucket","getBucket","highlightPoint","hasValue","resetPointHighLight","equals","xRounded","yRounded","highlightColor","darker","getBoundingClientRect","pageX","pageY","window","pageXOffset","pageYOffset","crosshair","showCrosshair","posX1","posX2","selectionX","selectionWidth","drawColorLegend","legendWidth","outerWidth","drawLegend","decimals","unitFormat","formatter","valueFormatter","legendY","legendX","legendContainer","labelMargin","minLabel","createMinMaxLabel","maxLabel","minLabelBox","maxLabelBox","labelHeight","labelWidth","legendMargin","labelY","legendScale","legendAxis","rangeStep","legendColorScale","positionRange","valueScale","xTime","yTime","dayIndex","bucketIndex","getBucketIndex","bucketX","bucketY","has","getTime","hasData","ROUND_DECIMALS","DO_NOT_ROUND","mul","pow","getFragment","empty","DEFAULT_X_TICK_SIZE_PX"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\nimport _ from 'lodash';\nimport moment from 'moment';\nimport $ from 'jquery';\n\nimport { getFragment } from '../fragments';\nimport CarpetplotTooltip from './tooltip';\nimport { valueFormatter } from '../formatting';\nimport { labelFormats } from '../x-axis-label-formats';\nimport themeProvider from '../theme-provider';\nimport colorModes from '../color-modes';\nimport { interpolationMap } from '../color-spaces';\nimport * as d3ScaleChromatic from '../libs/d3-scale-chromatic/index';\n\nconst\n  DEFAULT_X_TICK_SIZE_PX = 100,\n  X_AXIS_TICK_MIN_SIZE = 100,\n  Y_AXIS_TICK_PADDING = 5,\n  Y_AXIS_TICK_MIN_SIZE = 20,\n  MIN_SELECTION_WIDTH = 2,\n  LEGEND_HEIGHT = 40,\n  LEGEND_TOP_MARGIN = 10,\n  DO_NOT_ROUND = 'DO_NOT_DOUND',\n  ROUND_DECIMALS = DO_NOT_ROUND;\n\nexport default function link(scope, elem, attrs, ctrl) {\n  let data, panel, timeRange, carpet, canvas, context;\n\n  const $carpet = elem.find('.carpetplot-panel');\n  const tooltip = new CarpetplotTooltip($carpet, scope);\n\n  const margin = { left: 25, right: 15, top: 10, bottom: 10 };\n\n  let width, height,\n    min, max,\n    xFrom, xTo, days,\n    chartHeight, chartWidth,\n    chartTop, chartBottom,\n    xAxisHeight, yAxisWidth,\n    yScale, xScale,\n    legendHeight,\n    colorScale, fragment,\n    mouseUpHandler,\n    originalPointColor,\n    pointWidth, pointHeight,\n    pointWidthRounded, pointHeightRounded,\n    highlightContainer, highlightedBucket,\n    $canvas;\n\n  const selection = {\n    active: false,\n    x1: -1,\n    x2: -1\n  };\n\n  ctrl.events.on('render', () => {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function addCarpetplot() {\n    if (!data.data || !data.data[0]) { return; }\n\n    [min, max] = getMinMax();\n    colorScale = getColorScale(min, max);\n\n    addCarpetplotSvg();\n    addAxes();\n    addLegend();\n    addCanvas();\n    addPoints();\n    addHighlight();\n  }\n\n  function addCarpetplotSvg() {\n    width = Math.floor($carpet.width());\n    height = ctrl.height;\n\n    if (carpet) {\n      carpet.remove();\n    }\n\n    carpet = d3.select($carpet[0])\n      .append('svg')\n      .attr('width', width)\n      .attr('height', height);\n  }\n\n  function addAxes() {\n    legendHeight = panel.legend.show ? LEGEND_HEIGHT + LEGEND_TOP_MARGIN : 0;\n    xAxisHeight = panel.xAxis.hideLabels ? 0 : getXAxisHeight();\n    chartHeight = height - margin.top - margin.bottom - legendHeight - xAxisHeight;\n    chartTop = margin.top;\n    chartBottom = chartTop + chartHeight;\n\n    addYAxis();\n    yAxisWidth = panel.yAxis.hideLabels ? 0 : (getYAxisWidth() + Y_AXIS_TICK_PADDING);\n    chartWidth = width - yAxisWidth - margin.right;\n\n    addXAxis();\n\n    if (!panel.yAxis.show) {\n      carpet.select('.axis-y').selectAll('line').style('opacity', 0);\n    }\n\n    if (!panel.xAxis.show) {\n      carpet.select('.axis-x').selectAll('line').style('opacity', 0);\n      carpet.selectAll('.axis-x-weekends').selectAll('line').style('opacity', 0);\n    }\n  }\n\n  function addYAxis() {\n    yScale = d3.scaleTime()\n      .domain([moment().startOf('day').add(1, 'day'), moment().startOf('day')])\n      .range([chartHeight, 0]);\n\n    const yAxis = d3.axisLeft(yScale)\n      .ticks(getYAxisTicks())\n      .tickFormat((value) => moment(value).format('HH:mm'))\n      .tickSizeInner(0 - width)\n      .tickSizeOuter(0)\n      .tickPadding(Y_AXIS_TICK_PADDING);\n\n    if (!panel.yAxis.hideLabels) {\n      carpet.append('g')\n        .attr('class', 'axis axis-y')\n        .call(yAxis);\n\n      const posY = margin.top;\n      const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\n\n      const yAxisGroup = carpet.select('.axis-y');\n      yAxisGroup.attr('transform', `translate(${posX},${posY})`);\n      yAxisGroup.select('.domain').remove();\n      yAxisGroup.select('.tick:first-child').remove();\n      yAxisGroup.selectAll('.tick line').remove();\n    }\n  }\n\n  function getYAxisWidth() {\n    const axisText = carpet.selectAll('.axis-y text').nodes();\n    return d3.max(axisText, (text) => text.getBBox().width);\n  }\n\n  function getYAxisTicks() {\n    const count = chartHeight / Y_AXIS_TICK_MIN_SIZE;\n    const step = Math.max(2, Math.ceil(24 / count));\n    return d3.timeHour.every(step);\n  }\n\n  function addXAxis() {\n    xFrom = moment(data.data[0].time).startOf('day');\n    xTo = moment(data.data[data.data.length - 1].time).startOf('day').add(1, 'day');\n    days = xTo.diff(xFrom, 'days');\n\n    xScale = d3.scaleTime()\n      .domain([xFrom, xTo])\n      .range([0, chartWidth]);\n\n    const xAxis = d3.axisBottom(xScale)\n      .ticks(getXAxisTicks(xFrom, xTo))\n      .tickFormat(d3.timeFormat(panel.xAxis.labelFormat))\n      .tickSize(chartHeight);\n\n    const dayWidth = chartWidth / days;\n\n    const posY = margin.top;\n    const posX = yAxisWidth;\n\n    if (!panel.xAxis.hideLabels) {\n      carpet.append('g')\n        .attr('class', 'axis axis-x')\n        .attr('transform', `translate(${posX},${posY})`)\n        .call(xAxis)\n        .selectAll('text')\n        .style('text-anchor', 'end')\n        .attr('dx', '-.8em')\n        .attr('dy', '.15em')\n        .attr('y', 0)\n        .attr('transform', `translate(${5 + dayWidth / 2},${posY + chartHeight - 10}) rotate(-65)`);\n      carpet.select('.axis-x').selectAll('.tick line, .domain').remove();\n      carpet.select('.axis-x').select('.tick:last-child').remove();\n    }\n\n    if (panel.xAxis.showWeekends && dayWidth >= panel.xAxis.minBucketWidthToShowWeekends) {\n      addDayTicks(posX, posY, d3.timeSaturday.every(1));\n      addDayTicks(posX, posY, d3.timeMonday.every(1));\n    }\n  }\n\n  function addDayTicks(posX, posY, range) {\n    const ticks = d3.axisBottom(xScale)\n      .ticks(range)\n      .tickSize(chartHeight);\n    carpet.append('g')\n      .attr('class', 'axis-x-weekends')\n      .attr('transform', `translate(${posX},${posY})`)\n      .call(ticks)\n      .selectAll('text').remove();\n    carpet.select('.axis-x-weekends .domain').remove();\n  }\n\n  function getXAxisHeight() {\n    return labelFormats.find(({ value }) => value === panel.xAxis.labelFormat).height;\n    // const axis = carpet.select('.axis-x');\n    // if (!axis.empty()) {\n    //   const totalHeight = $(axis.node()).height();\n    //   return Math.max(totalHeight, totalHeight - chartHeight);\n    // }\n    // return 0;\n  }\n\n  function getXAxisTicks(from, to) {\n    const count = chartWidth / X_AXIS_TICK_MIN_SIZE;\n    const step = Math.ceil(days / count);\n    if (step < 7) {\n      return d3.timeDay.every(1);\n    }\n    if (step < 28) {\n      return d3.timeMonday.every(1);\n    }\n    return d3.timeMonth.every(1);\n  }\n\n  function addHighlight() {\n    highlightContainer = carpet.append('g')\n      .attr('class', 'points-highlight')\n      .attr('transform', `translate(${yAxisWidth},${margin.top})`);\n  }\n\n  function addCanvas() {\n    if (canvas) {\n      canvas.remove();\n    }\n\n    canvas = d3.select($carpet[0])\n      .insert('canvas', ':first-child')\n      .attr('width', chartWidth)\n      .attr('height', chartHeight)\n      .style('left', `${yAxisWidth}px`)\n      .style('top', `${margin.top}px`);\n\n    $canvas = $(canvas.node());\n\n    context = canvas.node().getContext('2d');\n  }\n\n  function addPoints() {\n    const customBase = document.createElement('custom');\n\n    const container = d3.select(customBase);\n\n    pointWidth = Math.max(0, chartWidth / days);\n    pointWidthRounded = round(pointWidth);\n    pointHeight = Math.max(0, chartHeight / fragment.count);\n    pointHeightRounded = round(pointHeight);\n\n    const pointScale = d3.scaleLinear()\n      .domain([fragment.count, 0])\n      .range([chartHeight, 0]);\n\n    const cols = container\n      .selectAll('custom.carpet-col')\n      .data(data.data)\n      .enter()\n      .append('custom')\n      .attr('class', 'carpet-col');\n\n    const points = cols\n      .selectAll('custom.carpet-point')\n      .data((d, i) => d.buckets.map(value => ({\n        value,\n        time: d.time\n      })))\n      .enter()\n      .append('custom')\n      .attr('class', 'carpet-point')\n      .attr('fillStyle', ({ value }) => value === null ? panel.color.nullColor : colorScale(value))\n      .attr('x', (d) => xScale(d.time.toDate()))\n      .attr('y', (d, i) => pointScale(i));\n\n    drawPoints(cols);\n  }\n\n  function drawPoints(cols) {\n    context.clearRect(0, 0, chartWidth, chartHeight);\n\n    const elements = cols.selectAll('custom.carpet-point')\n      .each(function (d, i) {\n        const node = d3.select(this);\n\n        const color = node.attr('fillStyle');\n        const x = round(node.attr('x'));\n        const y = round(node.attr('y'));\n\n        context.fillStyle = color;\n        context.fillRect(x, y, pointWidthRounded, pointHeightRounded);\n      });\n  }\n\n  function getMinMax() {\n    const { scale: { min, max }, color: { mode } } = panel;\n    const isSpectrumMode = mode === colorModes.SPECTRUM;\n    return [\n      isSpectrumMode && isSet(min) ? min : data.stats.min,\n      isSpectrumMode && isSet(max) ? max : data.stats.max\n    ];\n  }\n\n  const colorScales = {\n    [colorModes.SPECTRUM]: getColorScaleSpectrum,\n    [colorModes.CUSTOM]: getColorScaleCustom\n  };\n\n  function getColorScale(min, max) {\n    return colorScales[panel.color.mode](min, max);\n  }\n\n  function getColorScaleSpectrum(min, max) {\n    const theme = themeProvider.getTheme();\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\n    const colorInterpolator = d3ScaleChromatic[colorScheme.value];\n    const invert = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && theme === 'dark');\n    const domain = getStartEnd(min, max, invert);\n\n    return d3\n      .scaleSequential(colorInterpolator)\n      .domain(domain);\n  }\n\n  function getColorScaleCustom(min, max) {\n    let domain = [];\n\n    const colors = panel.color.customColors.map(color => color.color);\n    const interpolator = interpolationMap[panel.color.colorSpace];\n\n    const breakpoints = panel.color.customColors.map(color => color.breakpoint);\n    const firstBreakpoint = breakpoints.find(breakpoint => isDefined(breakpoint));\n    if (isDefined(firstBreakpoint)) {\n      // transform breakpoints\n      let last = 0;\n\n      const fill = (i, value) => {\n        const step = (value - domain[last]) / (i - last);\n        d3.range(i - last - 1).forEach((d, j) => {\n          domain[last + j + 1] = domain[last] + (j + 1) * step;\n          // setDomainValue(last + j + 1, domain[last] + (j + 1) * step);\n        });\n      };\n\n      for (let i = 0; i < breakpoints.length; i++) {\n        if (!isDefined(breakpoints[i])) {\n          // !set\n          if (i === 0) {\n            // color first\n            domain[i] = Math.min(min, firstBreakpoint < min ? -Number.MAX_VALUE : firstBreakpoint);\n            // setDomainValue(i, Math.min(min, firstBreakpoint));\n          } else if (i === breakpoints.length - 1) {\n            // color last\n            const maxVal = Math.max(max, domain[last]);\n            fill(i, maxVal);\n            domain[i] = maxVal;\n            // setDomainValue(i, maxVal);\n          }\n        } else if (i === 0) {\n          // set && color first\n          domain[i] = breakpoints[i];\n          // setDomainValue(i, breakpoints[i]);\n        } else {\n          // set && color 2..N\n          if (breakpoints[i] >= domain[last]) {\n            // valid breakpoint\n            fill(i, breakpoints[i]);\n            domain[i] = breakpoints[i];\n            // setDomainValue(i, breakpoints[i]);\n            last = i;\n          }\n        }\n      }\n    } else {\n      const [start, end] = getStartEnd(min, max);\n      const step = (end - start) / (colors.length - 1);\n      domain = d3.range(colors.length).map((d, i) => start + i * step);\n    }\n\n    if (domain[0] > min) {\n      domain.unshift(min);\n      colors.unshift(colors[0]);\n    }\n\n    if (domain[domain.length - 1] < max) {\n      domain.push(max);\n      colors.push(colors[colors.length - 1]);\n    }\n\n    return d3\n      .scaleLinear()\n      .domain(domain)\n      .range(colors)\n      .interpolate(interpolator);\n  }\n\n  function isDefined(value) {\n    return value !== undefined && value !== null;\n  }\n\n  function getStartEnd(min, max, invert = false) {\n    invert = panel.color.invert ? !invert : invert;\n    return [invert ? max : min, invert ? min : max];\n  }\n\n  function isSet(prop) {\n    return prop !== undefined && prop !== null && prop !== '';\n  }\n\n  function onMouseDown(event) {\n    const pos = getMousePos(event);\n    if (!isInChart(pos)) { return; }\n\n    selection.active = true;\n    selection.x1 = pos.x;\n\n    mouseUpHandler = () => onMouseUp();\n\n    $(document).one('mouseup', mouseUpHandler);\n  }\n\n  function onMouseUp() {\n    $(document).unbind('mouseup', mouseUpHandler);\n    mouseUpHandler = null;\n    selection.active = false;\n\n    const selectionRange = Math.abs(selection.x2 - selection.x1);\n\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\n      const timeFrom = moment(xScale.invert(Math.min(selection.x1, selection.x2))).startOf('day');\n      const timeTo = moment(xScale.invert(Math.max(selection.x1, selection.x2))).startOf('day').add(1, 'day');\n\n      ctrl.timeSrv.setTime({\n        from: moment.utc(timeFrom),\n        to: moment.utc(timeTo)\n      });\n    }\n\n    clearSelection();\n  }\n\n  function onMouseLeave() {\n    clearCrosshair();\n  }\n\n  function onMouseMove(event) {\n    if (!carpet) { return; }\n\n    const pos = getMousePos(event);\n\n    if (selection.active) {\n      clearCrosshair();\n      tooltip.destroy();\n\n      selection.x2 = pos.x;\n      drawSelection(selection.x1, selection.x2);\n    } else {\n      drawCrosshair(pos);\n\n      const bucket = getBucket(pos);\n      tooltip.show(pos, bucket);\n      highlightPoint(pos, bucket);\n    }\n  }\n\n  function highlightPoint(pos, bucket) {\n    if (!isInChart(pos) || !bucket || !bucket.hasValue()) {\n      resetPointHighLight();\n      return;\n    }\n\n    if (bucket.equals(highlightedBucket)) {\n      return;\n    } else {\n      resetPointHighLight();\n    }\n\n    highlightedBucket = bucket;\n\n    const { value, xRounded: x, yRounded: y } = bucket;\n\n    const color = colorScale(value);\n    const highlightColor = d3.color(color).darker(1);\n    originalPointColor = color;\n\n    highlightContainer\n      .append('rect')\n      .attr('x', x)\n      .attr('y', y)\n      .attr('width', pointWidthRounded)\n      .attr('height', pointHeightRounded)\n      .attr('fill', highlightColor);\n  }\n\n  function resetPointHighLight() {\n    if (!highlightedBucket) { return; }\n\n    highlightContainer.select('rect').remove();\n\n    highlightedBucket = null;\n  }\n\n  function getMousePos(event) {\n    const { left, top } = $canvas[0].getBoundingClientRect();\n    const { pageX, pageY } = event;\n    const pos = {\n      x: pageX - window.pageXOffset - left,\n      y: pageY - window.pageYOffset - top,\n      pageX,\n      pageY\n    };\n    return pos;\n  }\n\n  function drawCrosshair(pos) {\n    if (!carpet || !isInChart(pos)) {\n      clearCrosshair();\n      return;\n    }\n\n    carpet.selectAll('.heatmap-crosshair').remove();\n\n    const x = pos.x + yAxisWidth;\n    const y = pos.y + chartTop;\n\n    const crosshair = carpet.append('g')\n      .attr('class', 'heatmap-crosshair');\n\n    if (panel.xAxis.showCrosshair) {\n      crosshair.append('line')\n        .attr('x1', x)\n        .attr('y1', chartTop)\n        .attr('x2', x)\n        .attr('y2', chartBottom)\n        .attr('stroke-width', 1);\n    }\n\n    if (panel.yAxis.showCrosshair) {\n      crosshair.append('line')\n        .attr('x1', yAxisWidth)\n        .attr('y1', y)\n        .attr('x2', yAxisWidth + chartWidth)\n        .attr('y2', y)\n        .attr('stroke-width', 1);\n    }\n  }\n\n  function clearCrosshair() {\n    if (!carpet) { return; }\n\n    carpet.selectAll('.heatmap-crosshair').remove();\n  }\n\n  function drawSelection(posX1, posX2) {\n    if (!carpet) { return; }\n\n    carpet.selectAll('.carpet-selection').remove();\n    const selectionX = Math.min(posX1, posX2) + yAxisWidth;\n    const selectionWidth = Math.abs(posX1 - posX2);\n\n    if (selectionWidth > MIN_SELECTION_WIDTH) {\n      carpet.append('rect')\n        .attr('class', 'carpet-selection')\n        .attr('x', selectionX)\n        .attr('width', selectionWidth)\n        .attr('y', chartTop)\n        .attr('height', chartHeight);\n    }\n  }\n\n  function clearSelection() {\n    selection.x1 = -1;\n    selection.x2 = -1;\n\n    if (!carpet) { return; }\n\n    carpet.selectAll('.carpet-selection').remove();\n  }\n\n  function drawColorLegend() {\n    if (!colorScale) { return; }\n    d3.select(\"#heatmap-color-legend\").selectAll(\"rect\").remove();\n\n    const legend = d3.select(\"#heatmap-color-legend\");\n    const legendWidth = Math.floor($(d3.select(\"#heatmap-color-legend\").node()).outerWidth());\n    const legendHeight = d3.select(\"#heatmap-color-legend\").attr(\"height\");\n\n    drawLegend(legend, legendWidth, legendHeight);\n  }\n\n  function addLegend() {\n    if (!panel.legend.show) { return; }\n\n    const decimals = panel.data.decimals;\n    const format = panel.data.unitFormat;\n    const formatter = valueFormatter(format, decimals);\n\n    const legendY = yAxisWidth;\n    const legendX = margin.top + chartHeight + xAxisHeight + LEGEND_TOP_MARGIN;\n\n    const legendContainer = carpet.append('g')\n      .attr('class', 'carpet-legend')\n      .attr('transform', `translate(${legendY},${legendX})`);\n\n    const legendHeight = LEGEND_HEIGHT / 2;\n    const labelMargin = 5;\n\n    const minLabel = createMinMaxLabel(legendContainer, formatter(min));\n    const maxLabel = createMinMaxLabel(legendContainer, formatter(max));\n    const minLabelBox = minLabel.node().getBBox();\n    const maxLabelBox = maxLabel.node().getBBox();\n\n    const labelHeight = Math.ceil(Math.max(minLabelBox.height, maxLabelBox.height));\n    const labelWidth = Math.ceil(Math.max(minLabelBox.width, maxLabelBox.width));\n    const legendMargin = labelWidth + 2 * labelMargin;\n    const labelY = (legendHeight - labelHeight + 8) / 2;\n\n    minLabel\n      .attr('x', legendMargin / 2)\n      .attr('y', labelY);\n    maxLabel\n      .attr('x', chartWidth - legendMargin / 2)\n      .attr('y', labelY);\n\n    const legend = legendContainer.append('g')\n      .attr('transform', `translate(${legendMargin},0)`);\n\n    const legendWidth = chartWidth - 2 * legendMargin;\n    drawLegend(legend, legendWidth, legendHeight);\n\n    const legendScale = d3.scaleLinear()\n      .domain([min, max])\n      .range([0, legendWidth]);\n\n    const legendAxis = d3.axisBottom(legendScale)\n      .ticks(20)\n      .tickFormat(formatter)\n      .tickSize(legendHeight);\n\n    legendContainer.append('g')\n      .attr('class', 'legend-axis')\n      .call(legendAxis)\n      .attr('transform', `translate(${legendMargin},0)`)\n      .select('.domain').remove();\n  }\n\n  function createMinMaxLabel(legendContainer, text) {\n    return legendContainer.append('text')\n      .attr('class', 'min-max-label')\n      .attr('y', 0)\n      .attr('x', 0)\n      .attr('dy', '0.71em')\n      .attr('text-anchor', 'middle')\n      .text(text);\n  }\n\n  function drawLegend(legend, legendWidth, legendHeight, rangeStep = 2) {\n    const legendColorScale = getColorScale(0, legendWidth, min, max);\n    const positionRange = d3.range(0, legendWidth, rangeStep);\n\n    const valueScale = d3.scaleLinear()\n      .domain([0, legendWidth])\n      .range([min, max]);\n\n    return legend.selectAll(\".heatmap-color-legend-rect\")\n      .data(positionRange)\n      .enter()\n      .append(\"rect\")\n      .attr(\"x\", d => d)\n      .attr(\"y\", 0)\n      .attr(\"width\", rangeStep + 1) // Overlap rectangles to prevent gaps\n      .attr(\"height\", legendHeight)\n      .attr(\"stroke-width\", 0)\n      .attr(\"fill\", d => colorScale(valueScale(d)));\n  }\n\n  // Helpers\n\n  function isInChart(pos) {\n    const { x, y } = pos;\n\n    return x > 0\n      && x < chartWidth\n      && y > 0\n      && y < chartHeight;\n  }\n\n  function getBucket(pos) {\n    const { x, y } = pos;\n\n    const xTime = moment(xScale.invert(x)).startOf('day');\n    const yTime = moment(yScale.invert(y));\n\n    const dayIndex = xTime.diff(xFrom, 'days');\n    const bucketIndex = fragment.getBucketIndex(yTime);\n\n    const bucketX = xScale(xTime.toDate());\n    const bucketY = pointHeight * bucketIndex;\n\n    return _.has(data, `data[${dayIndex}].buckets[${bucketIndex}]`)\n      ? {\n        x: bucketX,\n        y: bucketY,\n        xRounded: round(bucketX),\n        yRounded: round(bucketY),\n        time: fragment.getTime(data.data[dayIndex].time, bucketIndex),\n        value: data.data[dayIndex].buckets[bucketIndex],\n        hasValue() {\n          return this.value !== null;\n        },\n        equals(bucket) {\n          return bucket && bucket.x === this.x && bucket.y === this.y;\n        }\n      }\n      : null;\n  }\n\n  function hasData() {\n    return data && data.data;\n  }\n\n  function round(value, decimals = ROUND_DECIMALS) {\n    if (decimals === DO_NOT_ROUND) { return value; }\n    if (!decimals) { return Math.round(value); }\n    const mul = Math.pow(10, decimals);\n    return Math.round(value * mul) / mul;\n  }\n\n  // Render\n\n  function render() {\n    data = ctrl.data;\n    panel = ctrl.panel;\n    timeRange = ctrl.range;\n\n    fragment = getFragment(panel.fragment);\n\n    addCarpetplot();\n\n    if (!d3.select(\"#heatmap-color-legend\").empty()) {\n      drawColorLegend();\n    }\n\n    scope.hasData = hasData;\n    scope.isInChart = isInChart;\n  }\n\n  $carpet.on('mousedown', onMouseDown);\n  $carpet.on('mousemove', onMouseMove);\n  $carpet.on('mouseleave', onMouseLeave);\n}"]}