{"version":3,"sources":["../../src/canvas/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","canvas","context","$carpet","find","tooltip","CarpetplotTooltip","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","days","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","xScale","legendHeight","colorScale","fragment","mouseUpHandler","originalPointColor","pointWidth","pointHeight","pointWidthRounded","pointHeightRounded","highlightContainer","highlightedBucket","$canvas","selection","active","x1","x2","events","on","render","renderingCompleted","addCarpetplot","getMinMax","getColorScale","addCarpetplotSvg","addAxes","addLegend","addCanvas","addPoints","addHighlight","Math","floor","remove","d3","select","append","attr","legend","show","LEGEND_HEIGHT","LEGEND_TOP_MARGIN","xAxis","hideLabels","getXAxisHeight","addYAxis","yAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","selectAll","style","scaleTime","domain","moment","startOf","add","range","axisLeft","ticks","getYAxisTicks","tickFormat","value","format","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","axisText","nodes","text","getBBox","count","Y_AXIS_TICK_MIN_SIZE","step","ceil","timeHour","every","time","length","diff","axisBottom","getXAxisTicks","timeFormat","labelFormat","tickSize","dayWidth","showWeekends","minBucketWidthToShowWeekends","addDayTicks","timeSaturday","timeMonday","labelFormats","from","to","X_AXIS_TICK_MIN_SIZE","timeDay","timeMonth","dpr","window","devicePixelRatio","insert","$","node","getContext","scale","customBase","document","createElement","container","round","pointScale","scaleLinear","cols","enter","points","d","i","buckets","map","color","nullColor","toDate","drawPoints","clearRect","elements","each","x","y","fillStyle","fillRect","mode","isSpectrumMode","colorModes","SPECTRUM","isSet","stats","colorScales","getColorScaleSpectrum","CUSTOM","getColorScaleCustom","theme","themeProvider","getTheme","colorScheme","_","colorSchemes","colorInterpolator","d3ScaleChromatic","invert","getStartEnd","scaleSequential","colors","customColors","interpolator","interpolationMap","colorSpace","breakpoints","breakpoint","firstBreakpoint","isDefined","last","fill","forEach","j","Number","MAX_VALUE","maxVal","start","end","unshift","push","interpolate","undefined","prop","onMouseDown","event","pos","getMousePos","isInChart","onMouseUp","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","utc","clearSelection","onMouseLeave","clearCrosshair","onMouseMove","destroy","drawSelection","drawCrosshair","bucket","getBucket","highlightPoint","hasValue","resetPointHighLight","equals","xRounded","yRounded","highlightColor","darker","getBoundingClientRect","pageX","pageY","pageXOffset","pageYOffset","crosshair","showCrosshair","posX1","posX2","selectionX","selectionWidth","drawColorLegend","legendWidth","outerWidth","drawLegend","decimals","unitFormat","formatter","valueFormatter","legendY","legendX","legendContainer","labelMargin","minLabel","createMinMaxLabel","maxLabel","minLabelBox","maxLabelBox","labelHeight","labelWidth","legendMargin","labelY","legendScale","legendAxis","rangeStep","legendColorScale","positionRange","valueScale","xTime","yTime","dayIndex","bucketIndex","getBucketIndex","bucketX","bucketY","has","getTime","hasData","ROUND_DECIMALS","DO_NOT_ROUND","mul","pow","getFragment","empty","DEFAULT_X_TICK_SIZE_PX"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport $ from 'jquery';\r\n\r\nimport { getFragment } from '../fragments';\r\nimport CarpetplotTooltip from './tooltip';\r\nimport { valueFormatter } from '../formatting';\r\nimport { labelFormats } from '../x-axis-label-formats';\r\nimport themeProvider from '../theme-provider';\r\nimport colorModes from '../color-modes';\r\nimport { interpolationMap } from '../color-spaces';\r\nimport * as d3ScaleChromatic from '../libs/d3-scale-chromatic/index';\r\n\r\nconst\r\n  DEFAULT_X_TICK_SIZE_PX = 100,\r\n  X_AXIS_TICK_MIN_SIZE = 100,\r\n  Y_AXIS_TICK_PADDING = 5,\r\n  Y_AXIS_TICK_MIN_SIZE = 20,\r\n  MIN_SELECTION_WIDTH = 2,\r\n  LEGEND_HEIGHT = 40,\r\n  LEGEND_TOP_MARGIN = 10,\r\n  DO_NOT_ROUND = 'DO_NOT_DOUND',\r\n  ROUND_DECIMALS = DO_NOT_ROUND;\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  let data, panel, timeRange, carpet, canvas, context;\r\n\r\n  const $carpet = elem.find('.carpetplot-panel');\r\n  const tooltip = new CarpetplotTooltip($carpet, scope);\r\n\r\n  const margin = { left: 25, right: 15, top: 10, bottom: 10 };\r\n\r\n  let width, height,\r\n    min, max,\r\n    xFrom, xTo, days,\r\n    chartHeight, chartWidth,\r\n    chartTop, chartBottom,\r\n    xAxisHeight, yAxisWidth,\r\n    yScale, xScale,\r\n    legendHeight,\r\n    colorScale, fragment,\r\n    mouseUpHandler,\r\n    originalPointColor,\r\n    pointWidth, pointHeight,\r\n    pointWidthRounded, pointHeightRounded,\r\n    highlightContainer, highlightedBucket,\r\n    $canvas;\r\n\r\n  const selection = {\r\n    active: false,\r\n    x1: -1,\r\n    x2: -1\r\n  };\r\n\r\n  ctrl.events.on('render', () => {\r\n    render();\r\n    ctrl.renderingCompleted();\r\n  });\r\n\r\n  function addCarpetplot() {\r\n    if (!data.data || !data.data[0]) { return; }\r\n\r\n    [min, max] = getMinMax();\r\n    colorScale = getColorScale(min, max);\r\n\r\n    addCarpetplotSvg();\r\n    addAxes();\r\n    addLegend();\r\n    addCanvas();\r\n    addPoints();\r\n    addHighlight();\r\n  }\r\n\r\n  function addCarpetplotSvg() {\r\n    width = Math.floor($carpet.width());\r\n    height = ctrl.height;\r\n\r\n    if (carpet) {\r\n      carpet.remove();\r\n    }\r\n\r\n    carpet = d3.select($carpet[0])\r\n      .append('svg')\r\n      .attr('width', width)\r\n      .attr('height', height);\r\n  }\r\n\r\n  function addAxes() {\r\n    legendHeight = panel.legend.show ? LEGEND_HEIGHT + LEGEND_TOP_MARGIN : 0;\r\n    xAxisHeight = panel.xAxis.hideLabels ? 0 : getXAxisHeight();\r\n    chartHeight = height - margin.top - margin.bottom - legendHeight - xAxisHeight;\r\n    chartTop = margin.top;\r\n    chartBottom = chartTop + chartHeight;\r\n\r\n    addYAxis();\r\n    yAxisWidth = panel.yAxis.hideLabels ? 0 : (getYAxisWidth() + Y_AXIS_TICK_PADDING);\r\n    chartWidth = width - yAxisWidth - margin.right;\r\n\r\n    addXAxis();\r\n\r\n    if (!panel.yAxis.show) {\r\n      carpet.select('.axis-y').selectAll('line').style('opacity', 0);\r\n    }\r\n\r\n    if (!panel.xAxis.show) {\r\n      carpet.select('.axis-x').selectAll('line').style('opacity', 0);\r\n      carpet.selectAll('.axis-x-weekends').selectAll('line').style('opacity', 0);\r\n    }\r\n  }\r\n\r\n  function addYAxis() {\r\n    yScale = d3.scaleTime()\r\n      .domain([moment().startOf('day').add(1, 'day'), moment().startOf('day')])\r\n      .range([chartHeight, 0]);\r\n\r\n    const yAxis = d3.axisLeft(yScale)\r\n      .ticks(getYAxisTicks())\r\n      .tickFormat((value) => moment(value).format('HH:mm'))\r\n      .tickSizeInner(0 - width)\r\n      .tickSizeOuter(0)\r\n      .tickPadding(Y_AXIS_TICK_PADDING);\r\n\r\n    if (!panel.yAxis.hideLabels) {\r\n      carpet.append('g')\r\n        .attr('class', 'axis axis-y')\r\n        .call(yAxis);\r\n\r\n      const posY = margin.top;\r\n      const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n\r\n      const yAxisGroup = carpet.select('.axis-y');\r\n      yAxisGroup.attr('transform', `translate(${posX},${posY})`);\r\n      yAxisGroup.select('.domain').remove();\r\n      yAxisGroup.select('.tick:first-child').remove();\r\n      yAxisGroup.selectAll('.tick line').remove();\r\n    }\r\n  }\r\n\r\n  function getYAxisWidth() {\r\n    const axisText = carpet.selectAll('.axis-y text').nodes();\r\n    return d3.max(axisText, (text) => text.getBBox().width);\r\n  }\r\n\r\n  function getYAxisTicks() {\r\n    const count = chartHeight / Y_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.max(2, Math.ceil(24 / count));\r\n    return d3.timeHour.every(step);\r\n  }\r\n\r\n  function addXAxis() {\r\n    xFrom = moment(data.data[0].time).startOf('day');\r\n    xTo = moment(data.data[data.data.length - 1].time).startOf('day').add(1, 'day');\r\n    days = xTo.diff(xFrom, 'days');\r\n\r\n    xScale = d3.scaleTime()\r\n      .domain([xFrom, xTo])\r\n      .range([0, chartWidth]);\r\n\r\n    const xAxis = d3.axisBottom(xScale)\r\n      .ticks(getXAxisTicks(xFrom, xTo))\r\n      .tickFormat(d3.timeFormat(panel.xAxis.labelFormat))\r\n      .tickSize(chartHeight);\r\n\r\n    const dayWidth = chartWidth / days;\r\n\r\n    const posY = margin.top;\r\n    const posX = yAxisWidth;\r\n\r\n    if (!panel.xAxis.hideLabels) {\r\n      carpet.append('g')\r\n        .attr('class', 'axis axis-x')\r\n        .attr('transform', `translate(${posX},${posY})`)\r\n        .call(xAxis)\r\n        .selectAll('text')\r\n        .style('text-anchor', 'end')\r\n        .attr('dx', '-.8em')\r\n        .attr('dy', '.15em')\r\n        .attr('y', 0)\r\n        .attr('transform', `translate(${5 + dayWidth / 2},${posY + chartHeight - 10}) rotate(-65)`);\r\n      carpet.select('.axis-x').selectAll('.tick line, .domain').remove();\r\n      carpet.select('.axis-x').select('.tick:last-child').remove();\r\n    }\r\n\r\n    if (panel.xAxis.showWeekends && dayWidth >= panel.xAxis.minBucketWidthToShowWeekends) {\r\n      addDayTicks(posX, posY, d3.timeSaturday.every(1));\r\n      addDayTicks(posX, posY, d3.timeMonday.every(1));\r\n    }\r\n  }\r\n\r\n  function addDayTicks(posX, posY, range) {\r\n    const ticks = d3.axisBottom(xScale)\r\n      .ticks(range)\r\n      .tickSize(chartHeight);\r\n    carpet.append('g')\r\n      .attr('class', 'axis-x-weekends')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(ticks)\r\n      .selectAll('text').remove();\r\n    carpet.select('.axis-x-weekends .domain').remove();\r\n  }\r\n\r\n  function getXAxisHeight() {\r\n    return labelFormats.find(({ value }) => value === panel.xAxis.labelFormat).height;\r\n    // const axis = carpet.select('.axis-x');\r\n    // if (!axis.empty()) {\r\n    //   const totalHeight = $(axis.node()).height();\r\n    //   return Math.max(totalHeight, totalHeight - chartHeight);\r\n    // }\r\n    // return 0;\r\n  }\r\n\r\n  function getXAxisTicks(from, to) {\r\n    const count = chartWidth / X_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.ceil(days / count);\r\n    if (step < 7) {\r\n      return d3.timeDay.every(1);\r\n    }\r\n    if (step < 28) {\r\n      return d3.timeMonday.every(1);\r\n    }\r\n    return d3.timeMonth.every(1);\r\n  }\r\n\r\n  function addHighlight() {\r\n    highlightContainer = carpet.append('g')\r\n      .attr('class', 'points-highlight')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top})`);\r\n  }\r\n\r\n  function addCanvas() {\r\n    if (canvas) {\r\n      canvas.remove();\r\n    }\r\n\r\n    var dpr = window.devicePixelRatio || 1;\r\n\r\n    canvas = d3.select($carpet[0])\r\n      .insert('canvas', ':first-child')\r\n      .attr('width', chartWidth * dpr)\r\n      .attr('height', chartHeight * dpr)\r\n      .style('width', `${chartWidth}px`)\r\n      .style('height', `${chartHeight}px`)\r\n      .style('left', `${yAxisWidth}px`)\r\n      .style('top', `${margin.top}px`);\r\n\r\n    $canvas = $(canvas.node());\r\n\r\n    context = canvas.node().getContext('2d');\r\n\r\n    context.scale(dpr, dpr);\r\n  }\r\n\r\n  function addPoints() {\r\n    const customBase = document.createElement('custom');\r\n\r\n    const container = d3.select(customBase);\r\n\r\n    pointWidth = Math.max(0, chartWidth / days);\r\n    pointWidthRounded = round(pointWidth);\r\n    pointHeight = Math.max(0, chartHeight / fragment.count);\r\n    pointHeightRounded = round(pointHeight);\r\n\r\n    const pointScale = d3.scaleLinear()\r\n      .domain([fragment.count, 0])\r\n      .range([chartHeight, 0]);\r\n\r\n    const cols = container\r\n      .selectAll('custom.carpet-col')\r\n      .data(data.data)\r\n      .enter()\r\n      .append('custom')\r\n      .attr('class', 'carpet-col');\r\n\r\n    const points = cols\r\n      .selectAll('custom.carpet-point')\r\n      .data((d, i) => d.buckets.map(value => ({\r\n        value,\r\n        time: d.time\r\n      })))\r\n      .enter()\r\n      .append('custom')\r\n      .attr('class', 'carpet-point')\r\n      .attr('fillStyle', ({ value }) => value === null ? panel.color.nullColor : colorScale(value))\r\n      .attr('x', (d) => xScale(d.time.toDate()))\r\n      .attr('y', (d, i) => pointScale(i));\r\n\r\n    drawPoints(cols);\r\n  }\r\n\r\n  function drawPoints(cols) {\r\n    context.clearRect(0, 0, chartWidth, chartHeight);\r\n\r\n    const elements = cols.selectAll('custom.carpet-point')\r\n      .each(function (d, i) {\r\n        const node = d3.select(this);\r\n\r\n        const color = node.attr('fillStyle');\r\n        const x = round(node.attr('x'));\r\n        const y = round(node.attr('y'));\r\n\r\n        context.fillStyle = color;\r\n        context.fillRect(x, y, pointWidthRounded, pointHeightRounded);\r\n      });\r\n  }\r\n\r\n  function getMinMax() {\r\n    const { scale: { min, max }, color: { mode } } = panel;\r\n    const isSpectrumMode = mode === colorModes.SPECTRUM;\r\n    return [\r\n      isSpectrumMode && isSet(min) ? min : data.stats.min,\r\n      isSpectrumMode && isSet(max) ? max : data.stats.max\r\n    ];\r\n  }\r\n\r\n  const colorScales = {\r\n    [colorModes.SPECTRUM]: getColorScaleSpectrum,\r\n    [colorModes.CUSTOM]: getColorScaleCustom\r\n  };\r\n\r\n  function getColorScale(min, max) {\r\n    return colorScales[panel.color.mode](min, max);\r\n  }\r\n\r\n  function getColorScaleSpectrum(min, max) {\r\n    const theme = themeProvider.getTheme();\r\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\r\n    const colorInterpolator = d3ScaleChromatic[colorScheme.value];\r\n    const invert = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && theme === 'dark');\r\n    const domain = getStartEnd(min, max, invert);\r\n\r\n    return d3\r\n      .scaleSequential(colorInterpolator)\r\n      .domain(domain);\r\n  }\r\n\r\n  function getColorScaleCustom(min, max) {\r\n    let domain = [];\r\n\r\n    const colors = panel.color.customColors.map(color => color.color);\r\n    const interpolator = interpolationMap[panel.color.colorSpace];\r\n\r\n    const breakpoints = panel.color.customColors.map(color => color.breakpoint);\r\n    const firstBreakpoint = breakpoints.find(breakpoint => isDefined(breakpoint));\r\n    if (isDefined(firstBreakpoint)) {\r\n      // transform breakpoints\r\n      let last = 0;\r\n\r\n      const fill = (i, value) => {\r\n        const step = (value - domain[last]) / (i - last);\r\n        d3.range(i - last - 1).forEach((d, j) => {\r\n          domain[last + j + 1] = domain[last] + (j + 1) * step;\r\n          // setDomainValue(last + j + 1, domain[last] + (j + 1) * step);\r\n        });\r\n      };\r\n\r\n      for (let i = 0; i < breakpoints.length; i++) {\r\n        if (!isDefined(breakpoints[i])) {\r\n          // !set\r\n          if (i === 0) {\r\n            // color first\r\n            domain[i] = Math.min(min, firstBreakpoint < min ? -Number.MAX_VALUE : firstBreakpoint);\r\n            // setDomainValue(i, Math.min(min, firstBreakpoint));\r\n          } else if (i === breakpoints.length - 1) {\r\n            // color last\r\n            const maxVal = Math.max(max, domain[last]);\r\n            fill(i, maxVal);\r\n            domain[i] = maxVal;\r\n            // setDomainValue(i, maxVal);\r\n          }\r\n        } else if (i === 0) {\r\n          // set && color first\r\n          domain[i] = breakpoints[i];\r\n          // setDomainValue(i, breakpoints[i]);\r\n        } else {\r\n          // set && color 2..N\r\n          if (breakpoints[i] >= domain[last]) {\r\n            // valid breakpoint\r\n            fill(i, breakpoints[i]);\r\n            domain[i] = breakpoints[i];\r\n            // setDomainValue(i, breakpoints[i]);\r\n            last = i;\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      const [start, end] = getStartEnd(min, max);\r\n      const step = (end - start) / (colors.length - 1);\r\n      domain = d3.range(colors.length).map((d, i) => start + i * step);\r\n    }\r\n\r\n    if (domain[0] > min) {\r\n      domain.unshift(min);\r\n      colors.unshift(colors[0]);\r\n    }\r\n\r\n    if (domain[domain.length - 1] < max) {\r\n      domain.push(max);\r\n      colors.push(colors[colors.length - 1]);\r\n    }\r\n\r\n    return d3\r\n      .scaleLinear()\r\n      .domain(domain)\r\n      .range(colors)\r\n      .interpolate(interpolator);\r\n  }\r\n\r\n  function isDefined(value) {\r\n    return value !== undefined && value !== null;\r\n  }\r\n\r\n  function getStartEnd(min, max, invert = false) {\r\n    invert = panel.color.invert ? !invert : invert;\r\n    return [invert ? max : min, invert ? min : max];\r\n  }\r\n\r\n  function isSet(prop) {\r\n    return prop !== undefined && prop !== null && prop !== '';\r\n  }\r\n\r\n  function onMouseDown(event) {\r\n    const pos = getMousePos(event);\r\n    if (!isInChart(pos)) { return; }\r\n\r\n    selection.active = true;\r\n    selection.x1 = pos.x;\r\n\r\n    mouseUpHandler = () => onMouseUp();\r\n\r\n    $(document).one('mouseup', mouseUpHandler);\r\n  }\r\n\r\n  function onMouseUp() {\r\n    $(document).unbind('mouseup', mouseUpHandler);\r\n    mouseUpHandler = null;\r\n    selection.active = false;\r\n\r\n    const selectionRange = Math.abs(selection.x2 - selection.x1);\r\n\r\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\r\n      const timeFrom = moment(xScale.invert(Math.min(selection.x1, selection.x2))).startOf('day');\r\n      const timeTo = moment(xScale.invert(Math.max(selection.x1, selection.x2))).startOf('day').add(1, 'day');\r\n\r\n      ctrl.timeSrv.setTime({\r\n        from: moment.utc(timeFrom),\r\n        to: moment.utc(timeTo)\r\n      });\r\n    }\r\n\r\n    clearSelection();\r\n  }\r\n\r\n  function onMouseLeave() {\r\n    clearCrosshair();\r\n  }\r\n\r\n  function onMouseMove(event) {\r\n    if (!carpet) { return; }\r\n\r\n    const pos = getMousePos(event);\r\n\r\n    if (selection.active) {\r\n      clearCrosshair();\r\n      tooltip.destroy();\r\n\r\n      selection.x2 = pos.x;\r\n      drawSelection(selection.x1, selection.x2);\r\n    } else {\r\n      drawCrosshair(pos);\r\n\r\n      const bucket = getBucket(pos);\r\n      tooltip.show(pos, bucket);\r\n      highlightPoint(pos, bucket);\r\n    }\r\n  }\r\n\r\n  function highlightPoint(pos, bucket) {\r\n    if (!isInChart(pos) || !bucket || !bucket.hasValue()) {\r\n      resetPointHighLight();\r\n      return;\r\n    }\r\n\r\n    if (bucket.equals(highlightedBucket)) {\r\n      return;\r\n    } else {\r\n      resetPointHighLight();\r\n    }\r\n\r\n    highlightedBucket = bucket;\r\n\r\n    const { value, xRounded: x, yRounded: y } = bucket;\r\n\r\n    const color = colorScale(value);\r\n    const highlightColor = d3.color(color).darker(1);\r\n    originalPointColor = color;\r\n\r\n    highlightContainer\r\n      .append('rect')\r\n      .attr('x', x)\r\n      .attr('y', y)\r\n      .attr('width', pointWidthRounded)\r\n      .attr('height', pointHeightRounded)\r\n      .attr('fill', highlightColor);\r\n  }\r\n\r\n  function resetPointHighLight() {\r\n    if (!highlightedBucket) { return; }\r\n\r\n    highlightContainer.select('rect').remove();\r\n\r\n    highlightedBucket = null;\r\n  }\r\n\r\n  function getMousePos(event) {\r\n    const { left, top } = $canvas[0].getBoundingClientRect();\r\n    const { pageX, pageY } = event;\r\n    const pos = {\r\n      x: pageX - window.pageXOffset - left,\r\n      y: pageY - window.pageYOffset - top,\r\n      pageX,\r\n      pageY\r\n    };\r\n    return pos;\r\n  }\r\n\r\n  function drawCrosshair(pos) {\r\n    if (!carpet || !isInChart(pos)) {\r\n      clearCrosshair();\r\n      return;\r\n    }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n\r\n    const x = pos.x + yAxisWidth;\r\n    const y = pos.y + chartTop;\r\n\r\n    const crosshair = carpet.append('g')\r\n      .attr('class', 'heatmap-crosshair');\r\n\r\n    if (panel.xAxis.showCrosshair) {\r\n      crosshair.append('line')\r\n        .attr('x1', x)\r\n        .attr('y1', chartTop)\r\n        .attr('x2', x)\r\n        .attr('y2', chartBottom)\r\n        .attr('stroke-width', 1);\r\n    }\r\n\r\n    if (panel.yAxis.showCrosshair) {\r\n      crosshair.append('line')\r\n        .attr('x1', yAxisWidth)\r\n        .attr('y1', y)\r\n        .attr('x2', yAxisWidth + chartWidth)\r\n        .attr('y2', y)\r\n        .attr('stroke-width', 1);\r\n    }\r\n  }\r\n\r\n  function clearCrosshair() {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n  }\r\n\r\n  function drawSelection(posX1, posX2) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n    const selectionX = Math.min(posX1, posX2) + yAxisWidth;\r\n    const selectionWidth = Math.abs(posX1 - posX2);\r\n\r\n    if (selectionWidth > MIN_SELECTION_WIDTH) {\r\n      carpet.append('rect')\r\n        .attr('class', 'carpet-selection')\r\n        .attr('x', selectionX)\r\n        .attr('width', selectionWidth)\r\n        .attr('y', chartTop)\r\n        .attr('height', chartHeight);\r\n    }\r\n  }\r\n\r\n  function clearSelection() {\r\n    selection.x1 = -1;\r\n    selection.x2 = -1;\r\n\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n  }\r\n\r\n  function drawColorLegend() {\r\n    if (!colorScale) { return; }\r\n    d3.select(\"#heatmap-color-legend\").selectAll(\"rect\").remove();\r\n\r\n    const legend = d3.select(\"#heatmap-color-legend\");\r\n    const legendWidth = Math.floor($(d3.select(\"#heatmap-color-legend\").node()).outerWidth());\r\n    const legendHeight = d3.select(\"#heatmap-color-legend\").attr(\"height\");\r\n\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n  }\r\n\r\n  function addLegend() {\r\n    if (!panel.legend.show) { return; }\r\n\r\n    const decimals = panel.data.decimals;\r\n    const format = panel.data.unitFormat;\r\n    const formatter = valueFormatter(format, decimals);\r\n\r\n    const legendY = yAxisWidth;\r\n    const legendX = margin.top + chartHeight + xAxisHeight + LEGEND_TOP_MARGIN;\r\n\r\n    const legendContainer = carpet.append('g')\r\n      .attr('class', 'carpet-legend')\r\n      .attr('transform', `translate(${legendY},${legendX})`);\r\n\r\n    const legendHeight = LEGEND_HEIGHT / 2;\r\n    const labelMargin = 5;\r\n\r\n    const minLabel = createMinMaxLabel(legendContainer, formatter(min));\r\n    const maxLabel = createMinMaxLabel(legendContainer, formatter(max));\r\n    const minLabelBox = minLabel.node().getBBox();\r\n    const maxLabelBox = maxLabel.node().getBBox();\r\n\r\n    const labelHeight = Math.ceil(Math.max(minLabelBox.height, maxLabelBox.height));\r\n    const labelWidth = Math.ceil(Math.max(minLabelBox.width, maxLabelBox.width));\r\n    const legendMargin = labelWidth + 2 * labelMargin;\r\n    const labelY = (legendHeight - labelHeight + 8) / 2;\r\n\r\n    minLabel\r\n      .attr('x', legendMargin / 2)\r\n      .attr('y', labelY);\r\n    maxLabel\r\n      .attr('x', chartWidth - legendMargin / 2)\r\n      .attr('y', labelY);\r\n\r\n    const legend = legendContainer.append('g')\r\n      .attr('transform', `translate(${legendMargin},0)`);\r\n\r\n    const legendWidth = chartWidth - 2 * legendMargin;\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n\r\n    const legendScale = d3.scaleLinear()\r\n      .domain([min, max])\r\n      .range([0, legendWidth]);\r\n\r\n    const legendAxis = d3.axisBottom(legendScale)\r\n      .ticks(20)\r\n      .tickFormat(formatter)\r\n      .tickSize(legendHeight);\r\n\r\n    legendContainer.append('g')\r\n      .attr('class', 'legend-axis')\r\n      .call(legendAxis)\r\n      .attr('transform', `translate(${legendMargin},0)`)\r\n      .select('.domain').remove();\r\n  }\r\n\r\n  function createMinMaxLabel(legendContainer, text) {\r\n    return legendContainer.append('text')\r\n      .attr('class', 'min-max-label')\r\n      .attr('y', 0)\r\n      .attr('x', 0)\r\n      .attr('dy', '0.71em')\r\n      .attr('text-anchor', 'middle')\r\n      .text(text);\r\n  }\r\n\r\n  function drawLegend(legend, legendWidth, legendHeight, rangeStep = 2) {\r\n    const legendColorScale = getColorScale(0, legendWidth, min, max);\r\n    const positionRange = d3.range(0, legendWidth, rangeStep);\r\n\r\n    const valueScale = d3.scaleLinear()\r\n      .domain([0, legendWidth])\r\n      .range([min, max]);\r\n\r\n    return legend.selectAll(\".heatmap-color-legend-rect\")\r\n      .data(positionRange)\r\n      .enter()\r\n      .append(\"rect\")\r\n      .attr(\"x\", d => d)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", rangeStep + 1) // Overlap rectangles to prevent gaps\r\n      .attr(\"height\", legendHeight)\r\n      .attr(\"stroke-width\", 0)\r\n      .attr(\"fill\", d => colorScale(valueScale(d)));\r\n  }\r\n\r\n  // Helpers\r\n\r\n  function isInChart(pos) {\r\n    const { x, y } = pos;\r\n\r\n    return x > 0\r\n      && x < chartWidth\r\n      && y > 0\r\n      && y < chartHeight;\r\n  }\r\n\r\n  function getBucket(pos) {\r\n    const { x, y } = pos;\r\n\r\n    const xTime = moment(xScale.invert(x)).startOf('day');\r\n    const yTime = moment(yScale.invert(y));\r\n\r\n    const dayIndex = xTime.diff(xFrom, 'days');\r\n    const bucketIndex = fragment.getBucketIndex(yTime);\r\n\r\n    const bucketX = xScale(xTime.toDate());\r\n    const bucketY = pointHeight * bucketIndex;\r\n\r\n    return _.has(data, `data[${dayIndex}].buckets[${bucketIndex}]`)\r\n      ? {\r\n        x: bucketX,\r\n        y: bucketY,\r\n        xRounded: round(bucketX),\r\n        yRounded: round(bucketY),\r\n        time: fragment.getTime(data.data[dayIndex].time, bucketIndex),\r\n        value: data.data[dayIndex].buckets[bucketIndex],\r\n        hasValue() {\r\n          return this.value !== null;\r\n        },\r\n        equals(bucket) {\r\n          return bucket && bucket.x === this.x && bucket.y === this.y;\r\n        }\r\n      }\r\n      : null;\r\n  }\r\n\r\n  function hasData() {\r\n    return data && data.data;\r\n  }\r\n\r\n  function round(value, decimals = ROUND_DECIMALS) {\r\n    if (decimals === DO_NOT_ROUND) { return value; }\r\n    if (!decimals) { return Math.round(value); }\r\n    const mul = Math.pow(10, decimals);\r\n    return Math.round(value * mul) / mul;\r\n  }\r\n\r\n  // Render\r\n\r\n  function render() {\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n    timeRange = ctrl.range;\r\n\r\n    fragment = getFragment(panel.fragment);\r\n\r\n    addCarpetplot();\r\n\r\n    if (!d3.select(\"#heatmap-color-legend\").empty()) {\r\n      drawColorLegend();\r\n    }\r\n\r\n    scope.hasData = hasData;\r\n    scope.isInChart = isInChart;\r\n  }\r\n\r\n  $carpet.on('mousedown', onMouseDown);\r\n  $carpet.on('mousemove', onMouseMove);\r\n  $carpet.on('mouseleave', onMouseLeave);\r\n}"]}